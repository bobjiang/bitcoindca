"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[907],{4219:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"core-concepts/execution-pipeline","title":"Execution Pipeline","description":"Follow the end-to-end flow from keeper scheduling through guard validation, routing, settlement, and telemetry emission.","source":"@site/docs/core-concepts/execution-pipeline.md","sourceDirName":"core-concepts","slug":"/core-concepts/execution-pipeline","permalink":"/docs/core-concepts/execution-pipeline","draft":false,"unlisted":false,"editUrl":"https://github.com/bobjiang/bitcoindca/tree/main/docs/docs/core-concepts/execution-pipeline.md","tags":[],"version":"current","frontMatter":{"title":"Execution Pipeline","sidebar_label":"Execution Pipeline","description":"Follow the end-to-end flow from keeper scheduling through guard validation, routing, settlement, and telemetry emission."},"sidebar":"primarySidebar","previous":{"title":"Position Model","permalink":"/docs/core-concepts/positions"},"next":{"title":"Security Controls","permalink":"/docs/core-concepts/security-controls"}}');var t=n(7711),r=n(6879);const o={title:"Execution Pipeline",sidebar_label:"Execution Pipeline",description:"Follow the end-to-end flow from keeper scheduling through guard validation, routing, settlement, and telemetry emission."},c="Execution Pipeline",l={},d=[{value:"Schedule flow",id:"schedule-flow",level:2},{value:"<code>Executor.execute</code> steps",id:"executorexecute-steps",level:2},{value:"MEV posture",id:"mev-posture",level:2},{value:"Failure handling",id:"failure-handling",level:2},{value:"Observability",id:"observability",level:2}];function a(e){const i={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.header,{children:(0,t.jsx)(i.h1,{id:"execution-pipeline",children:"Execution Pipeline"})}),"\n",(0,t.jsx)(i.p,{children:"BitcoinDCA relies on a layered automation stack to guarantee timely execution while prioritising safety and MEV resistance."}),"\n",(0,t.jsx)(i.h2,{id:"schedule-flow",children:"Schedule flow"}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.code,{children:"nextExecAt"})," is initialised when a position is created or resumed."]}),"\n",(0,t.jsxs)(i.li,{children:["Chainlink Automation monitors ",(0,t.jsx)(i.code,{children:"checkUpkeep"}),"-style conditions off-chain. When a position becomes eligible (time reached, funds available, guards healthy), the keeper submits a transaction to ",(0,t.jsx)(i.code,{children:"Executor.execute"}),"."]}),"\n",(0,t.jsx)(i.li,{children:"If Chainlink misses the window, Gelato tasks kick in using mirrored conditions."}),"\n",(0,t.jsx)(i.li,{children:"After a configurable grace period, anyone can execute publicly. Public execution tightens slippage tolerances and charges a capped tip to discourage griefing."}),"\n"]}),"\n",(0,t.jsxs)(i.p,{children:["The helper ",(0,t.jsx)(i.code,{children:"isPositionEligible"})," (covered in ",(0,t.jsx)(i.code,{children:"contracts/test/dcaManager.abi.spec.ts"}),") offers a lightweight call for keepers to pre-filter candidates."]}),"\n",(0,t.jsxs)(i.h2,{id:"executorexecute-steps",children:[(0,t.jsx)(i.code,{children:"Executor.execute"})," steps"]}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Eligibility check"})," \u2014 Re-validates time window and the paused state."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Oracle validation"})," \u2014 Reads Chainlink feeds (USDC/USD, BTC/USD, ETH/USD, WBTC/BTC) and compares against Uniswap v3 TWAP data. Stale or deviating prices revert with custom errors (",(0,t.jsx)(i.code,{children:"StaleOracle"}),", ",(0,t.jsx)(i.code,{children:"PriceDeviationExceeded"}),")."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Gas guard"})," \u2014 If the current base fee or priority fee exceeds the position's limit, execution aborts with reason ",(0,t.jsx)(i.code,{children:"GAS_CAP"}),"."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Routing"})," \u2014 Selects adapter based on position venue:","\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"AUTO"})," \u2014 Ask routing engine to evaluate liquidity and slippage."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"UNIV3_ONLY"})," \u2014 Direct swap against configured pools."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"COW_ONLY"})," \u2014 Submit order to CoW batch auction (supports partial fills)."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"AGGREGATOR"})," \u2014 Use 1inch API pathing via the ",(0,t.jsx)(i.code,{children:"OneInchAdapter"}),"."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Settlement"})," \u2014 Updates manager balances, increments ",(0,t.jsx)(i.code,{children:"periodsExec"}),", schedules the next timestamp, and collects protocol fees."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Telemetry"})," \u2014 Emits ",(0,t.jsx)(i.code,{children:"ExecutionDetails"})," with gas usage, route path, price impact, and data points for monitoring systems."]}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"Execution success and skipped cases are validated in the behaviour and security tests:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-typescript",metastring:'title="contracts/test/security/MEVProtection.test.ts"',children:'await expect(executor.connect(keeper).execute(positionId))\n  .to.emit(executor, "ExecutionCompleted")\n  .withArgs(positionId, keeper.address);\n\nawait expect(executor.connect(keeper).execute(positionIdWithBadPrice))\n  .to.emit(executor, "ExecutionSkipped")\n  .withArgs(positionIdWithBadPrice, "PRICE_DEVIATION");\n'})}),"\n",(0,t.jsx)(i.h2,{id:"mev-posture",children:"MEV posture"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Private routing:"})," Flashbots bundles and CoW batch auctions prevent back-running and sandwich attacks whenever possible."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Fallback public routing:"})," Enforces stricter slippage (",(0,t.jsx)(i.code,{children:"slippageBps / 2"}),") and tags executions so the analytics layer can flag degraded venues."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Record keeping:"})," Events track ",(0,t.jsx)(i.code,{children:"venue"}),", ",(0,t.jsx)(i.code,{children:"mode"}),", ",(0,t.jsx)(i.code,{children:"priceUsd"}),", and ",(0,t.jsx)(i.code,{children:"gasUsed"}),", giving operators and users a clear audit trail."]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"failure-handling",children:"Failure handling"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Guard failure:"})," Emits ",(0,t.jsx)(i.code,{children:"ExecutionSkipped"}),". The position stays active, and ",(0,t.jsx)(i.code,{children:"nextExecAt"})," is delayed by one interval. Historical skips feed into analytics to spot persistent issues."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Routing error:"})," Adapters bubble up custom errors (e.g., ",(0,t.jsx)(i.code,{children:"CowOrderNotFilled"}),"). The executor maps them to skip reasons and avoids double-spending gas."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Oracle discrepancy:"})," Circuit breaker can trigger ",(0,t.jsx)(i.code,{children:"CircuitBreakerTriggered"})," to pause the system globally until the multisig intervenes."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Automation outage:"})," Gelato and public execution ensure liveness, while the treasury funds emergency tips if required."]}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"observability",children:"Observability"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Events:"})," ",(0,t.jsx)(i.code,{children:"ExecutionDetails"})," provides structured payloads for monitors."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Position views:"})," ",(0,t.jsx)(i.code,{children:"getPosition"})," and ",(0,t.jsx)(i.code,{children:"getPositionBalance"})," power the frontend dashboard (",(0,t.jsx)(i.code,{children:"frontend"})," package)."]}),"\n",(0,t.jsxs)(i.li,{children:[(0,t.jsx)(i.strong,{children:"Testing hooks:"})," Fixtures in ",(0,t.jsx)(i.code,{children:"contracts/test/fixtures/deployments.ts"})," deploy a full stack for simulation, letting you reproduce pipeline states cheaply."]}),"\n"]})]})}function h(e={}){const{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},6879:(e,i,n)=>{n.d(i,{R:()=>o,x:()=>c});var s=n(3303);const t={},r=s.createContext(t);function o(e){const i=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function c(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:i},e.children)}}}]);