"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[272],{3337:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"core-concepts/positions","title":"Position Model","description":"Understand how DCA Crypto represents strategies, balances, and limits inside the DcaManager contract.","source":"@site/docs/core-concepts/positions.md","sourceDirName":"core-concepts","slug":"/core-concepts/positions","permalink":"/docs/core-concepts/positions","draft":false,"unlisted":false,"editUrl":"https://github.com/bobjiang/dcacrypto/tree/main/docs/docs/core-concepts/positions.md","tags":[],"version":"current","frontMatter":{"title":"Position Model","sidebar_label":"Position Model","description":"Understand how DCA Crypto represents strategies, balances, and limits inside the DcaManager contract."},"sidebar":"primarySidebar","previous":{"title":"Glossary","permalink":"/docs/overview/glossary"},"next":{"title":"Execution Pipeline","permalink":"/docs/core-concepts/execution-pipeline"}}');var i=t(7711),r=t(6879);const o={title:"Position Model",sidebar_label:"Position Model",description:"Understand how DCA Crypto represents strategies, balances, and limits inside the DcaManager contract."},c="Position Model",a={},d=[{value:"Lifecycle",id:"lifecycle",level:2},{value:"Frequency and timing",id:"frequency-and-timing",level:2},{value:"Guardrails",id:"guardrails",level:2},{value:"Accounting",id:"accounting",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"position-model",children:"Position Model"})}),"\n",(0,i.jsxs)(n.p,{children:["Every strategy in DCA Crypto is stored as a ",(0,i.jsx)(n.code,{children:"Position"})," struct within the ",(0,i.jsx)(n.code,{children:"DcaManager"}),". Each position is linked to a ",(0,i.jsx)(n.code,{children:"PositionNFT"})," that grants ownership rights and governs authorisation for modifications."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-solidity",metastring:'title="contracts/storage/PositionStorage.sol"',children:"struct Position {\n  address owner;\n  address beneficiary;\n  address quote;\n  bool    isBuy;\n  uint16  freq;\n  uint16  venue;\n  uint16  slippageBps;\n  uint32  twapWindow;\n  uint16  maxPriceDeviationBps;\n  uint64  nextExecAt;\n  uint64  startAt;\n  uint64  endAt;\n  uint32  periodsExec;\n  uint128 amountPerPeriod;\n  uint128 priceFloorUsd;\n  uint128 priceCapUsd;\n  bool    paused;\n  uint64  maxBaseFeeWei;\n  uint64  maxPriorityFeeWei;\n}\nmapping(uint256 => uint256) quoteBal;\nmapping(uint256 => uint256) baseBal;\n"})}),"\n",(0,i.jsx)(n.h2,{id:"lifecycle",children:"Lifecycle"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Create"})," \u2014 A wallet (or Safe) calls ",(0,i.jsx)(n.code,{children:"createPosition"}),". The manager mints a ",(0,i.jsx)(n.code,{children:"PositionNFT"}),", stores parameters, and schedules the first execution via ",(0,i.jsx)(n.code,{children:"nextExecAt"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Fund"})," \u2014 Users deposit assets via ",(0,i.jsx)(n.code,{children:"deposit"}),", increasing ",(0,i.jsx)(n.code,{children:"quoteBal"})," (for buys) or ",(0,i.jsx)(n.code,{children:"baseBal"})," (for sells)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Execute"})," \u2014 Keepers call ",(0,i.jsx)(n.code,{children:"Executor.execute(positionId)"})," once ",(0,i.jsx)(n.code,{children:"nextExecAt"})," is reached. The executor validates guards, routes the swap, updates balances, and emits telemetry."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Modify"})," \u2014 Owners may adjust guard parameters, MEV mode, or beneficiary through ",(0,i.jsx)(n.code,{children:"modify"}),". Immutable fields (quote, base, startAt) remain locked."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Pause / Resume"})," \u2014 Temporarily halt execution without withdrawing. Resume recalculates ",(0,i.jsx)(n.code,{children:"nextExecAt"})," based on the configured frequency."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Cancel"})," \u2014 Closes the position and refunds balances to the beneficiary."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Emergency Withdraw"})," \u2014 After a timelock delay, owners can pull funds irrespective of executor state, guaranteeing liveness in adverse conditions."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"frequency-and-timing",children:"Frequency and timing"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"freq"})," encodes daily (0), weekly (1), or monthly (2)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"startAt"})," ensures the first execution does not trigger before a specific timestamp."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"nextExecAt"})," is updated after each execution using the helper schedule logic in the manager; skipped executions requeue for the next interval."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The behaviour test ",(0,i.jsx)(n.a,{href:"https://github.com/bobjiang/dcacrypto/blob/main/contracts/test/system.behavior.spec.ts",children:(0,i.jsx)(n.code,{children:"contracts/test/system.behavior.spec.ts"})})," demonstrates the full lifecycle by creating a weekly USDC\u2192WBTC position, funding it, waiting for the execution window, and verifying that:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="contracts/test/system.behavior.spec.ts"',children:'await expect(executor.connect(keeper).execute(positionId))\n  .to.emit(executor, "ExecutionCompleted")\n  .withArgs(positionId, await keeper.getAddress());\n'})}),"\n",(0,i.jsx)(n.h2,{id:"guardrails",children:"Guardrails"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Slippage:"})," Stored per position and clamped by the manager-wide maximum."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"TWAP window & deviation:"})," Protects against sudden price spikes by comparing against both Chainlink and on-chain TWAP prices."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Price caps / floors:"})," Hard USD guard rails for aggressive market movements."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Gas caps:"})," Optional ",(0,i.jsx)(n.code,{children:"maxBaseFeeWei"})," and ",(0,i.jsx)(n.code,{children:"maxPriorityFeeWei"})," values prevent execution when the network is congested."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Guard enforcement is validated in ",(0,i.jsx)(n.code,{children:"contracts/test/security/DOSProtection.test.ts"})," and ",(0,i.jsx)(n.code,{children:"contracts/test/system.behavior.spec.ts"}),". When a guard trips, the executor emits:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",metastring:'title="contracts/test/system.behavior.spec.ts"',children:'await expect(executor.connect(keeper).execute(positionId))\n  .to.emit(executor, "ExecutionSkipped")\n  .withArgs(positionId, "PRICE_DEVIATION");\n'})}),"\n",(0,i.jsx)(n.h2,{id:"accounting",children:"Accounting"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Deposits and withdrawals adjust ",(0,i.jsx)(n.code,{children:"quoteBal"})," and ",(0,i.jsx)(n.code,{children:"baseBal"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Executions consume quote (buys) or base (sells) funds and accrue the counter-asset into the opposite balance."}),"\n",(0,i.jsx)(n.li,{children:"Protocol fees are calculated per execution and forwarded to the Treasury."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Both balances are queryable via ",(0,i.jsx)(n.code,{children:"getPositionBalance(positionId)"})," which returns the latest quote/base reserves for UI rendering."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},6879:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var s=t(3303);const i={},r=s.createContext(i);function o(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);