"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[72],{2273:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"developer/smart-contracts","title":"Smart Contract Reference","description":"Detailed reference for the BitcoinDCA smart contracts, including key functions, parameters, and interoperability notes.","source":"@site/docs/developer/smart-contracts.md","sourceDirName":"developer","slug":"/developer/smart-contracts","permalink":"/docs/developer/smart-contracts","draft":false,"unlisted":false,"editUrl":"https://github.com/bobjiang/bitcoindca/tree/main/docs/docs/developer/smart-contracts.md","tags":[],"version":"current","frontMatter":{"title":"Smart Contract Reference","sidebar_label":"Smart Contracts","description":"Detailed reference for the BitcoinDCA smart contracts, including key functions, parameters, and interoperability notes."},"sidebar":"primarySidebar","previous":{"title":"Architecture","permalink":"/docs/developer/architecture"},"next":{"title":"Integration Guide","permalink":"/docs/developer/integration-guide"}}');var i=n(7711),r=n(6879);const d={title:"Smart Contract Reference",sidebar_label:"Smart Contracts",description:"Detailed reference for the BitcoinDCA smart contracts, including key functions, parameters, and interoperability notes."},c="Smart Contract Reference",o={},l=[{value:"DcaManager",id:"dcamanager",level:2},{value:"Key functions",id:"key-functions",level:3},{value:"Configuration structs",id:"configuration-structs",level:3},{value:"PositionNFT",id:"positionnft",level:2},{value:"Executor",id:"executor",level:2},{value:"PriceOracle",id:"priceoracle",level:2},{value:"Treasury",id:"treasury",level:2},{value:"Router adapters",id:"router-adapters",level:2},{value:"TypeScript bindings",id:"typescript-bindings",level:2}];function a(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"smart-contract-reference",children:"Smart Contract Reference"})}),"\n",(0,i.jsxs)(t.p,{children:["This section summarises the public interface of the audited smart contracts. It draws on the ABI tests under ",(0,i.jsx)(t.code,{children:"contracts/test/*.abi.spec.ts"})," to ensure accuracy."]}),"\n",(0,i.jsx)(t.h2,{id:"dcamanager",children:"DcaManager"}),"\n",(0,i.jsx)(t.p,{children:"Responsible for position lifecycle, accounting, and guard configuration."}),"\n",(0,i.jsx)(t.h3,{id:"key-functions",children:"Key functions"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Function"}),(0,i.jsx)(t.th,{children:"Purpose"}),(0,i.jsx)(t.th,{children:"Notes"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"initialize(address admin, address executor, address priceOracle, address treasury)"})}),(0,i.jsx)(t.td,{children:"Proxy initialiser"}),(0,i.jsxs)(t.td,{children:["Reverts on re-initialisation (see ",(0,i.jsx)(t.code,{children:"system.behavior.spec.ts"}),")."]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"createPosition(CreatePositionParams params)"})}),(0,i.jsx)(t.td,{children:"Create and schedule a new position"}),(0,i.jsxs)(t.td,{children:["Mints a ",(0,i.jsx)(t.code,{children:"PositionNFT"}),", emits ",(0,i.jsx)(t.code,{children:"PositionCreated"}),"."]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"modify(uint256 positionId, ModifyParams params)"})}),(0,i.jsx)(t.td,{children:"Adjust mutable fields"}),(0,i.jsx)(t.td,{children:"Immutable fields revert with custom errors."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsxs)(t.td,{children:[(0,i.jsx)(t.code,{children:"pause(uint256 positionId)"})," / ",(0,i.jsx)(t.code,{children:"resume(uint256 positionId)"})]}),(0,i.jsx)(t.td,{children:"Toggle execution"}),(0,i.jsxs)(t.td,{children:["Emits ",(0,i.jsx)(t.code,{children:"Paused"})," / ",(0,i.jsx)(t.code,{children:"Resumed"}),"."]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"cancel(uint256 positionId)"})}),(0,i.jsx)(t.td,{children:"Close a position"}),(0,i.jsx)(t.td,{children:"Burns the NFT and refunds balances."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"deposit(uint256 positionId, address token, uint256 amount)"})}),(0,i.jsx)(t.td,{children:"Add idle balances"}),(0,i.jsx)(t.td,{children:"Token must match position direction."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"withdraw(uint256 positionId, address token, uint256 amount, address to)"})}),(0,i.jsx)(t.td,{children:"Remove funds"}),(0,i.jsx)(t.td,{children:"Enforces ownership/beneficiary checks."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"emergencyWithdraw(uint256 positionId)"})}),(0,i.jsx)(t.td,{children:"Initiate delayed exit"}),(0,i.jsx)(t.td,{children:"Requires timelock before completion."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"getPosition(uint256 positionId)"})}),(0,i.jsx)(t.td,{children:"Returns full position struct"}),(0,i.jsx)(t.td,{children:"Used by dashboard tables."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"getPositionBalance(uint256 positionId)"})}),(0,i.jsxs)(t.td,{children:["Returns ",(0,i.jsx)(t.code,{children:"(quoteBal, baseBal)"})]}),(0,i.jsxs)(t.td,{children:["Aligns with ",(0,i.jsx)(t.code,{children:"PositionView"})," in frontend."]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"positionsByOwner(address owner)"})}),(0,i.jsx)(t.td,{children:"Enumerate positions"}),(0,i.jsx)(t.td,{children:"Enables pagination in UI."})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"configuration-structs",children:"Configuration structs"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"ProtocolConfig"}),": protocol fee bps, execution fee, fee collector, referral defaults."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"CircuitBreakerConfig"}),": global caps, min size, depeg limits."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"VenueConfig"}),": adapter addresses, MEV defaults."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Setters (",(0,i.jsx)(t.code,{children:"setProtocolConfig"}),", ",(0,i.jsx)(t.code,{children:"setCircuitBreakerConfig"}),", ",(0,i.jsx)(t.code,{children:"setVenueConfig"}),", ",(0,i.jsx)(t.code,{children:"setKeeperRegistry"}),") are role-gated and covered by ABI tests."]}),"\n",(0,i.jsx)(t.h2,{id:"positionnft",children:"PositionNFT"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["ERC-721 token minted on ",(0,i.jsx)(t.code,{children:"createPosition"}),"."]}),"\n",(0,i.jsx)(t.li,{children:"Metadata fetched from off-chain storage to avoid upgrade conflicts."}),"\n",(0,i.jsxs)(t.li,{children:["Roles ",(0,i.jsx)(t.code,{children:"MINTER_ROLE"})," / ",(0,i.jsx)(t.code,{children:"BURNER_ROLE"})," restricted to the manager."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"executor",children:"Executor"}),"\n",(0,i.jsxs)(t.p,{children:["Entry point for keepers. All external functions are ",(0,i.jsx)(t.code,{children:"nonReentrant"}),"."]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Function"}),(0,i.jsx)(t.th,{children:"Purpose"}),(0,i.jsx)(t.th,{children:"Highlights"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"execute(uint256 positionId)"})}),(0,i.jsx)(t.td,{children:"Trigger a single position"}),(0,i.jsx)(t.td,{children:"Validates guardrails, selects venue, settles balances."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"batchExecute(uint256[] calldata positionIds)"})}),(0,i.jsx)(t.td,{children:"Multi-position execution"}),(0,i.jsx)(t.td,{children:"Used by Chainlink Automation to amortise gas."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"simulate(uint256 positionId)"})}),(0,i.jsx)(t.td,{children:"Static-call helper"}),(0,i.jsx)(t.td,{children:"Off-chain simulation for monitoring tools."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"setKeeper(address keeper, bool allowed)"})}),(0,i.jsx)(t.td,{children:"Manage authorised executors"}),(0,i.jsxs)(t.td,{children:["Gated by ",(0,i.jsx)(t.code,{children:"KEEPER_ROLE"}),"."]})]})]})]}),"\n",(0,i.jsx)(t.p,{children:"Events:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"ExecutionCompleted(uint256 positionId, address keeper)"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"ExecutionSkipped(uint256 positionId, string reason)"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"ExecutionDetails(uint256 positionId, address keeper, uint256 gasUsed, bytes routePath, int256 priceImpactBps, uint256 twapWindow, uint256 oracleTimestamp)"})}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"priceoracle",children:"PriceOracle"}),"\n",(0,i.jsx)(t.p,{children:"Combines Chainlink feeds and Uniswap v3 TWAPs."}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Function"}),(0,i.jsx)(t.th,{children:"Description"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"getQuoteUsd(address token)"})}),(0,i.jsx)(t.td,{children:"Returns USD price with 8 decimals."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"getTwap(address pool, uint32 window)"})}),(0,i.jsx)(t.td,{children:"Calculates TWAP price/seconds using Uniswap v3 observations."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"validatePrice(address base, address quote, uint32 window, uint16 deviationBps)"})}),(0,i.jsxs)(t.td,{children:["Returns ",(0,i.jsx)(t.code,{children:"(bool ok, uint256 priceUsd, uint256 deviationBps)"})," used by the executor."]})]})]})]}),"\n",(0,i.jsxs)(t.p,{children:["ABI tests (",(0,i.jsx)(t.code,{children:"contracts/test/oracle.abi.spec.ts"}),") ensure function availability and event signatures."]}),"\n",(0,i.jsx)(t.h2,{id:"treasury",children:"Treasury"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Holds protocol execution fees."}),"\n",(0,i.jsxs)(t.li,{children:["Exposes ",(0,i.jsx)(t.code,{children:"withdraw(address token, uint256 amount, address to)"})," and timelocked ",(0,i.jsx)(t.code,{children:"schedule/execute"})," operations."]}),"\n",(0,i.jsxs)(t.li,{children:["Uses OpenZeppelin ",(0,i.jsx)(t.code,{children:"AccessControl"})," with ",(0,i.jsx)(t.code,{children:"TREASURER_ROLE"})," and ",(0,i.jsx)(t.code,{children:"FEE_COLLECTOR_ROLE"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"router-adapters",children:"Router adapters"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Adapter"}),(0,i.jsx)(t.th,{children:"Responsibility"}),(0,i.jsx)(t.th,{children:"Notes"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"UniV3Adapter"})}),(0,i.jsx)(t.td,{children:"Exact-input swaps across specified fee tiers"}),(0,i.jsx)(t.td,{children:"Supports Flashbots private transactions."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"CowAdapter"})}),(0,i.jsx)(t.td,{children:"Submits orders to CoW Protocol"}),(0,i.jsx)(t.td,{children:"Handles partial fills and settlement callbacks."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"OneInchAdapter"})}),(0,i.jsx)(t.td,{children:"Integrates with 1inch API payloads"}),(0,i.jsx)(t.td,{children:"Used when Auto routing favours aggregator liquidity."})]})]})]}),"\n",(0,i.jsxs)(t.p,{children:["Adapters have minimal mutable state and forward custom errors back to the executor. Review ",(0,i.jsx)(t.code,{children:"contracts/test/routerAdapters.abi.spec.ts"})," for exposed function names and events."]}),"\n",(0,i.jsx)(t.h2,{id:"typescript-bindings",children:"TypeScript bindings"}),"\n",(0,i.jsxs)(t.p,{children:["Generated via TypeChain (",(0,i.jsx)(t.code,{children:"pnpm -F contracts typechain"}),"). Example usage:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-typescript",metastring:'title="frontend/lib/actions/createPosition.ts"',children:'import { DcaManager__factory, type IDcaManager } from "@bitcoindca/contracts/typechain";\nimport { getWalletClient } from "wagmi/actions";\nimport { CONTRACT_ADDRESSES } from "../config";\n\nexport async function createPosition(params: IDcaManager.CreatePositionParamsStruct) {\n  const wallet = await getWalletClient();\n  if (!wallet) throw new Error("Wallet not connected");\n\n  const manager = DcaManager__factory.connect(CONTRACT_ADDRESSES.DCA_MANAGER, wallet as any);\n  return manager.createPosition(params);\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"The bindings share types with the documentation examples, improving copy/paste fidelity."})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},6879:(e,t,n)=>{n.d(t,{R:()=>d,x:()=>c});var s=n(3303);const i={},r=s.createContext(i);function d(e){const t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);